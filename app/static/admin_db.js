function setMsg(s){document.getElementById('adminMsg').textContent=s||'';}function getSecret(){return localStorage.getItem('admin_secret')||'';}function setSecret(v){localStorage.setItem('admin_secret',v||'');}async function loadInfo(){setMsg('');const r=await fetch('/api/admin/dbinfo');const info=await r.json();const e=document.getElementById('dbinfo');function esc(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}const rows=[['Engine',info.engine+(info.engine_version?' '+info.engine_version:'')],['Dialect',info.dialect],['URL',info.url_masked],['Size',info.size_human||'unknown'],['Schema version',String(info.db_version)],['Required version',String(info.required_version)],['Obsolete',info.obsolete?'yes':'no'],['Export supported',info.export_supported?'yes':'no'],['Import supported',info.import_supported?'yes':'no'],];e.innerHTML=rows.map(r=>`<div><label>${esc(r[0])}</label><div>${esc(r[1])}</div></div>`).join('');document.getElementById('migrateBtn').style.display=info.obsolete?'inline-block':'none';}document.getElementById('saveSecretBtn').onclick=()=>{const v=document.getElementById('adminSecret').value;setSecret(v);setMsg('Secret saved in browser storage.');};document.getElementById('clearSecretBtn').onclick=()=>{setSecret('');document.getElementById('adminSecret').value='';setMsg('Secret cleared.');};document.getElementById('exportBtn').onclick=async()=>{setMsg('');try{const r=await fetch('/api/admin/export',{method:'POST',headers:{'X-Admin-Secret':getSecret()}});if(!r.ok){const t=await r.text();setMsg('Export failed: '+t);return;}const blob=await r.blob();const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='timeboard-export.db';a.click();URL.revokeObjectURL(a.href);setMsg('Export succeeded.');}catch(e){setMsg('Export error.');}};document.getElementById('importFile').onchange=async(ev)=>{const file=ev.target.files[0];if(!file)return;if(!confirm('Replace the database with the selected file? This cannot be undone.'))return;setMsg('');const fd=new FormData();fd.append('file',file);try{const r=await fetch('/api/admin/import',{method:'POST',headers:{'X-Admin-Secret':getSecret()},body:fd});const t=await r.text();if(!r.ok){setMsg('Import failed: '+t);return;}setMsg('Import succeeded. The service may need a restart to release old connections.');await loadInfo();}catch(e){setMsg('Import error.');}};document.getElementById('migrateBtn').onclick=async()=>{setMsg('');try{const r=await fetch('/api/admin/migrate',{method:'POST',headers:{'X-Admin-Secret':getSecret()}});const t=await r.text();if(!r.ok){setMsg('Migrate failed: '+t);return;}setMsg('Migration complete.');await loadInfo();}catch(e){setMsg('Migration error.');}};loadInfo();