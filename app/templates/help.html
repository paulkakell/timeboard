{% extends "base.html" %}

{% block content %}
<h1>Help</h1>

<p class="text-muted">
  Timeboard is a lightweight task tracker with tags, recurring tasks, notifications, and a complete JSON API.
</p>

<hr>

<h2>Core concepts</h2>

<h3>Tasks</h3>
<ul>
  <li><strong>Name</strong>: the task title.</li>
  <li><strong>Due date</strong>: stored in UTC and displayed using your browser's locale.</li>
  <li><strong>Status</strong>: <code>pending</code>, <code>completed</code>, or <code>archived</code>.</li>
  <li><strong>URL</strong> (optional): if provided, notifications link to this URL; otherwise they link to the in-app task editor.</li>
  <li><strong>Tags</strong>: free-form labels used for organization and (optionally) notification routing.</li>
</ul>

<h3>Tags</h3>
<p>
  Tags are global (per installation) but tasks are always scoped to a user account. Tags are used for filtering and for routing notifications.
</p>

<hr>

<h2>Notifications</h2>

<p>
  Notifications are configured <strong>per user</strong> via <a href="/profile/notifications">Profile → Notifications</a>.
  Each notification service entry creates a unique tag. If a task includes that tag, notifications are sent to that service whenever the task changes.
</p>

<p class="text-muted">
  Non-browser notifications (email/webhooks/etc.) are dispatched asynchronously. If a send fails, the delivery status and an error summary are recorded on the notification event log (and in the application logs).
</p>

<h3>What triggers notifications</h3>
<ul>
  <li><strong>created</strong>: a new task is created</li>
  <li><strong>updated</strong>: an existing task is edited (including tags, due date, URL, etc.)</li>
  <li><strong>past_due</strong>: the task is overdue (sent by the scheduled overdue scan)</li>
  <li><strong>completed</strong>: the task is completed</li>
  <li><strong>archived</strong>: the task is archived</li>
</ul>

<h3>Notification routing (service tags)</h3>
<ol>
  <li>Create one or more notification services in your profile.</li>
  <li>Copy the generated <code>notify:…</code> tag for that service (tip: click the tag in the Notifications page to copy).</li>
  <li>Add that tag to any task you want routed to that service.</li>
  <li>If a task has multiple service tags, it will send to multiple services.</li>
</ol>

<h3>Notification message format</h3>
<p>
  Notifications use this canonical text format:
</p>
<pre><code>&lt;CHANGE_ACTION&gt;:&lt;URL&gt;&lt;TASK_NAME&gt;&lt;/URL&gt; -&lt;DUE_DATE&gt; [&lt;TAGS&gt;]</code></pre>
<p class="text-muted">
  The URL is the task's configured URL if present, otherwise it links to the in-app task editor.
</p>

<h3>Supported notification services</h3>

<p>
  Each service type has a small configuration payload. You can create multiple entries per type (for example, multiple Gotify tokens or multiple webhooks).
</p>

<ul>
  <li><strong>Browser</strong>: delivered to the currently-open browser via an SSE stream. Requires browser permission.</li>
  <li><strong>Email</strong>: sends an email per notification. Requires admin SMTP configuration.</li>
  <li><strong>Windows Push Notifications (WNS)</strong>: requires admin WNS credentials and a per-device channel URI in your service entry.</li>
  <li><strong>Gotify</strong>: posts to a Gotify server using an application token.</li>
  <li><strong>ntfy</strong>: posts to an ntfy topic (supports optional token and click-through link).</li>
  <li><strong>Discord</strong>: posts to a Discord channel via webhook (uses an embed so the task name is clickable when an absolute URL is available).</li>
  <li><strong>Generic webhook</strong>: POSTs a JSON payload to a URL; optional secret is sent as <code>X-Timeboard-Secret</code>.</li>
  <li><strong>Generic API</strong>: calls a configurable URL/method with optional headers/token and a JSON body (for POST/PUT/PATCH).</li>
</ul>

<h3>Example service configuration payloads</h3>
<p class="text-muted">
  These match the fields shown in the profile notifications UI and the <code>/api/notifications/services</code> endpoints.
</p>

<pre><code>{
  "service_type": "gotify",
  "name": "Phone",
  "enabled": true,
  "config": {
    "base_url": "https://gotify.example.com",
    "token": "YOUR_APP_TOKEN",
    "priority": 5
  }
}</code></pre>

<pre><code>{
  "service_type": "ntfy",
  "name": "Personal",
  "enabled": true,
  "config": {
    "server_url": "https://ntfy.sh",
    "topic": "my-topic",
    "token": "OPTIONAL_BEARER_TOKEN",
    "priority": "high"
  }
}</code></pre>

<pre><code>{
  "service_type": "webhook",
  "name": "Automation",
  "enabled": true,
  "config": {
    "url": "https://example.com/webhook/timeboard",
    "secret": "OPTIONAL_SHARED_SECRET"
  }
}</code></pre>

<pre><code>{
  "service_type": "generic_api",
  "name": "Custom API",
  "enabled": true,
  "config": {
    "url": "https://api.example.com/v1/events",
    "method": "POST",
    "token": "OPTIONAL_BEARER_TOKEN",
    "headers": {
      "X-App": "timeboard"
    }
  }
}</code></pre>

<hr>

<h2>Admin settings</h2>

<h3>Email (SMTP)</h3>
<p>
  SMTP settings are configured in <a href="/admin/email">Admin → Email</a> and stored in the database.
  The sample <code>settings.yml</code> can be used once to seed initial values, but runtime configuration is managed in the admin UI (or via the admin API).
</p>

<h3>Push notifications (WNS)</h3>
<p>
  Global WNS credentials are configured in <a href="/admin/notifications">Admin → Push Notifications</a>.
  Users then add per-device <code>channel_uri</code> values in their own notification service entries.
</p>

<h3>Application logs</h3>
<p>
  Logs are written to <code>/data/logs</code> (one file per day) with standard levels: DEBUG, INFO, WARN, ERROR.
  Retention and log level are configured in <a href="/admin/logs">Admin → Logs</a>.
</p>

<hr>

<h2>API</h2>

<p>
  Interactive API documentation is available at <a href="/docs">/docs</a> (OpenAPI/Swagger UI).
</p>


<h3>Endpoint reference</h3>

<p class="text-muted">
  All endpoints below are rooted at the same Timeboard base URL. Most endpoints require an API token.
</p>

<h4>/api/auth</h4>
<ul>
  <li><code>POST /api/auth/token</code> — obtain an access token (form-encoded <code>username</code>/<code>password</code>).</li>
</ul>

<h4>/api/users</h4>
<ul>
  <li><code>GET /api/users/me</code> — get the current user.</li>
  <li><code>PATCH /api/users/me</code> — update current user (name/email/password).</li>
  <li><code>GET /api/users/</code> — list users (admin).</li>
  <li><code>POST /api/users/</code> — create user (admin).</li>
  <li><code>PATCH /api/users/{user_id}</code> — update user (admin).</li>
  <li><code>DELETE /api/users/{user_id}</code> — delete user (admin).</li>
</ul>

<h4>/api/tasks</h4>
<ul>
  <li><code>GET /api/tasks/</code> — list tasks (supports filters like <code>status</code>, due windows, and pagination).</li>
  <li><code>POST /api/tasks/</code> — create task.</li>
  <li><code>GET /api/tasks/{task_id}</code> — get task.</li>
  <li><code>PUT /api/tasks/{task_id}</code> — update task.</li>
  <li><code>DELETE /api/tasks/{task_id}</code> — archive task.</li>
  <li><code>POST /api/tasks/{task_id}/complete</code> — mark complete.</li>
  <li><code>POST /api/tasks/{task_id}/restore</code> — restore from completed/archived.</li>
</ul>

<h4>/api/tags</h4>
<ul>
  <li><code>GET /api/tags/</code> — list tags for current user (admin can list tags for a specific user via <code>?user_id=</code>).</li>
</ul>

<h4>/api/notifications</h4>
<ul>
  <li><code>GET /api/notifications/services</code> — list your notification services (includes generated routing tags).</li>
  <li><code>POST /api/notifications/services</code> — create a notification service entry (creates a routing tag).</li>
  <li><code>GET /api/notifications/services/{service_id}</code> — get a service entry.</li>
  <li><code>PUT /api/notifications/services/{service_id}</code> — update a service entry.</li>
  <li><code>DELETE /api/notifications/services/{service_id}</code> — delete a service entry (also deletes its generated tag).</li>
  <li><code>GET /api/notifications/events</code> — list notification events (filterable by <code>service_type</code>, <code>task_id</code>, <code>before_id</code>, <code>after_id</code>).</li>
</ul>

<h4>/api/admin</h4>
<ul>
  <li><code>GET /api/admin/email</code> — get SMTP/email settings (admin).</li>
  <li><code>PUT /api/admin/email</code> — update SMTP/email settings (admin).</li>
  <li><code>GET /api/admin/logging</code> — get logging settings (admin).</li>
  <li><code>PUT /api/admin/logging</code> — update logging settings (admin).</li>
  <li><code>GET /api/admin/wns</code> — get WNS settings (admin).</li>
  <li><code>PUT /api/admin/wns</code> — update WNS settings (admin).</li>
  <li><code>GET /api/admin/logs/files</code> — list log files (admin).</li>
  <li><code>GET /api/admin/logs/files/{filename}?max_lines=...</code> — read the tail of a log file (admin).</li>
</ul>

<hr>
<h3>Authentication</h3>
<p>
  Obtain a token with:
</p>
<pre><code>curl -X POST -d "username=YOUR_USERNAME&amp;password=YOUR_PASSWORD" \
  http://localhost:8000/api/auth/token</code></pre>

<p>
  Use the returned token as:
</p>
<pre><code>Authorization: Bearer &lt;ACCESS_TOKEN&gt;</code></pre>

<h3>Common API examples</h3>

<p>Create a task:</p>
<pre><code>curl -X POST http://localhost:8000/api/tasks/ \
  -H "Authorization: Bearer &lt;TOKEN&gt;" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Pay rent",
    "due_date_utc": "2026-03-01T00:00:00Z",
    "tags": ["finance", "notify:u1:ntfy:abcd1234"]
  }'</code></pre>

<p>List tasks (pending):</p>
<pre><code>curl http://localhost:8000/api/tasks/?status=pending \
  -H "Authorization: Bearer &lt;TOKEN&gt;"</code></pre>

<p>Create a notification service:</p>
<pre><code>curl -X POST http://localhost:8000/api/notifications/services \
  -H "Authorization: Bearer &lt;TOKEN&gt;" \
  -H "Content-Type: application/json" \
  -d '{
    "service_type": "ntfy",
    "name": "Phone",
    "enabled": true,
    "config": {
      "server_url": "https://ntfy.sh",
      "topic": "my-topic"
    }
  }'</code></pre>

<p>List your notification services (and copy the generated tag):</p>
<pre><code>curl http://localhost:8000/api/notifications/services \
  -H "Authorization: Bearer &lt;TOKEN&gt;"</code></pre>

<p>List notification events:</p>
<pre><code>curl http://localhost:8000/api/notifications/events?limit=50 \
  -H "Authorization: Bearer &lt;TOKEN&gt;"</code></pre>

<h3>Admin API examples</h3>
<p class="text-muted">Admin endpoints require an admin user.</p>

<p>Update SMTP settings:</p>
<pre><code>curl -X PUT http://localhost:8000/api/admin/email \
  -H "Authorization: Bearer &lt;ADMIN_TOKEN&gt;" \
  -H "Content-Type: application/json" \
  -d '{
    "enabled": true,
    "smtp_host": "smtp.example.com",
    "smtp_port": 587,
    "smtp_username": "user@example.com",
    "smtp_password": "YOUR_PASSWORD",
    "smtp_from": "Timeboard &lt;timeboard@example.com&gt;",
    "use_tls": true
  }'</code></pre>

<p>List log files:</p>
<pre><code>curl http://localhost:8000/api/admin/logs/files \
  -H "Authorization: Bearer &lt;ADMIN_TOKEN&gt;"</code></pre>

<p>Read the tail of a log file:</p>
<pre><code>curl "http://localhost:8000/api/admin/logs/files/timeboard-2026-02-20.log?max_lines=2000" \
  -H "Authorization: Bearer &lt;ADMIN_TOKEN&gt;"</code></pre>

{% endblock %}
