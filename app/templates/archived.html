{% extends "base.html" %}
{% block content %}
<h1 class="h4 mb-3">Archived Tasks</h1>

<form class="row g-2 align-items-end mb-3" method="get" action="/archived">
  <div class="col-12 col-md-3">
    <label class="form-label">Filter by Tag</label>
    <input class="form-control" type="text" name="tag" value="{{ tag_filter or '' }}" placeholder="e.g. finance">
  </div>

  {% if current_user.is_admin %}
  <div class="col-12 col-md-3">
    <label class="form-label">View</label>
    <select class="form-select" name="user_id">
      <option value="{{ current_user.id }}" {% if user_filter == current_user.id %}selected{% endif %}>My Tasks</option>
      <option value="0" {% if user_filter == 0 %}selected{% endif %}>All Tasks</option>
      {% for u in all_users %}
        {% if u.id != current_user.id %}
          <option value="{{ u.id }}" {% if user_filter == u.id %}selected{% endif %}>{{ u.username }}</option>
        {% endif %}
      {% endfor %}
    </select>
  </div>
  {% endif %}

  <div class="col-12 col-md-3">
    <label class="form-label">Task Type</label>
    <select class="form-select" name="task_type">
      <option value="" {% if not task_type_filter %}selected{% endif %}>All Types</option>
      {% for tt in task_types %}
        <option value="{{ tt }}" {% if task_type_filter == tt %}selected{% endif %}>{{ tt }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-12 col-md-2">
    <label class="form-label">Sort</label>
    <select class="form-select" name="sort">
      <option value="archived_at" {% if sort == 'archived_at' %}selected{% endif %}>Archived Date</option>
      <option value="task_type" {% if sort == 'task_type' or sort == 'type' %}selected{% endif %}>Task Type</option>
      <option value="name" {% if sort == 'name' %}selected{% endif %}>Task Name</option>
    </select>
  </div>

  <div class="col-12 col-md-1 d-grid">
    <button class="btn btn-primary" type="submit">Apply</button>
  </div>

  <div class="col-12">
    <a class="btn btn-sm btn-outline-secondary" href="/archived">Reset</a>
    <a class="btn btn-sm btn-outline-secondary" href="/dashboard">Back to Dashboard</a>
  </div>
</form>

{% if tasks|length == 0 %}
  <div class="alert alert-info">No archived tasks found.</div>
{% else %}
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          {% if current_user.is_admin and user_filter == 0 %}<th>User</th>{% endif %}
          <th style="min-width: 160px;">Archived</th>
          <th>Task Name</th>
          <th>Task Type</th>
          <th>Tags</th>
          <th class="text-end" style="min-width: 120px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for row in tasks %}
          {% set t = row.task %}
          <tr>
            {% if current_user.is_admin and user_filter == 0 %}<td>{{ t.user.username }}</td>{% endif %}
            <td>
              <div class="fw-semibold">{{ t.status }}</div>
              <div class="small text-muted">{{ row.archived_at|dt_local }}</div>
            </td>
            <td>
              <div class="fw-semibold">{{ t.name }}</div>
              {% if t.description %}<div class="small text-muted">{{ t.description }}</div>{% endif %}
              <div class="small text-muted">Due {{ t.due_date_utc|dt_local }}</div>
              {% if t.url %}<div class="small"><a href="{{ t.url }}" target="_blank" rel="noopener">{{ t.url }}</a></div>{% endif %}
            </td>
            <td>{{ t.task_type }}</td>
            <td>
              {% if t.tags %}
                {% for tag in t.tags %}
                  <span class="badge text-bg-secondary">{{ tag.name }}</span>
                {% endfor %}
              {% endif %}
            </td>
            <td class="text-end">
              <form method="post" action="/tasks/{{ t.id }}/restore" class="d-inline">
                <button class="btn btn-sm btn-primary" type="submit">Restore</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endif %}
{% endblock %}
