{% extends "base.html" %}

{% block title %}{% if mode == 'new' %}New Task{% else %}Edit Task{% endif %}{% endblock %}

{% block content %}
{% set _can_edit = (can_edit if can_edit is defined else True) %}

<div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <h2 class="mb-1">{% if mode == 'new' %}New Task{% else %}Edit Task{% endif %}</h2>
    {% if parent_task %}
      <div class="small text-muted">
        Parent: <a href="/tasks/{{ parent_task.id }}/edit?next={{ next_url|urlencode }}">{{ parent_task.name }}</a>
      </div>
    {% elif task and task.parent_task_id %}
      {# parent_task may be None if missing #}
      <div class="small text-muted">Parent task id: {{ task.parent_task_id }}</div>
    {% endif %}
  </div>

  {% if mode == 'edit' %}
  <div class="d-flex gap-2">
    {% if can_follow is defined and can_follow %}
      {% if is_following %}
        <form method="post" action="/tasks/{{ task.id }}/unfollow">
          <input type="hidden" name="next" value="{{ request.url.path }}?next={{ next_url|urlencode }}">
          <button class="btn btn-outline-secondary btn-sm" type="submit">Unfollow</button>
        </form>
      {% else %}
        <form method="post" action="/tasks/{{ task.id }}/follow">
          <input type="hidden" name="next" value="{{ request.url.path }}?next={{ next_url|urlencode }}">
          <button class="btn btn-outline-secondary btn-sm" type="submit">Follow</button>
        </form>
      {% endif %}
    {% endif %}

    {% if _can_edit and task %}
      <form method="post" action="/tasks/{{ task.id }}/clone">
        <input type="hidden" name="next" value="{{ next_url }}">
        <button class="btn btn-outline-secondary btn-sm" type="submit">Clone</button>
      </form>
    {% endif %}

    {% if task and (current_user.is_admin or _can_edit or (can_follow is defined and can_follow)) %}
      {% set next_self = '/tasks/' ~ task.id ~ '/edit?next=' ~ (next_url|urlencode) %}
      <a class="btn btn-outline-secondary btn-sm" href="/tasks/new?parent_task_id={{ task.id }}&next={{ next_self|urlencode }}">Add subtask</a>
    {% endif %}
  </div>
  {% endif %}
</div>

{% if error %}
  <div class="alert alert-danger">{{ error }}</div>
{% endif %}

<form method="post" action="{% if mode == 'new' %}/tasks/new{% else %}/tasks/{{ task.id }}/edit{% endif %}">
  <input type="hidden" name="next" value="{{ next_url }}">
  {% if mode == 'new' and parent_task_id %}
    <input type="hidden" name="parent_task_id" value="{{ parent_task_id }}">
  {% endif %}

  <div class="row g-3">
    {% if mode == 'new' and assignee_options is defined and (assignee_options|length > 1 or current_user.is_admin) %}
      <div class="col-12 col-md-6">
        <label class="form-label">Assignee</label>
        {% if assignee_locked %}
          <input type="hidden" name="assignee_user_id" value="{{ selected_assignee_id }}">
          <input class="form-control" type="text" value="{% if parent_task and parent_task.user %}{{ parent_task.user.username }}{% else %}{{ selected_assignee_id }}{% endif %}" readonly>
        {% else %}
          <select class="form-select" name="assignee_user_id">
            {% for u in assignee_options %}
              <option value="{{ u.id }}" {% if selected_assignee_id == u.id %}selected{% endif %}>{{ u.username }}</option>
            {% endfor %}
          </select>
        {% endif %}
      </div>
    {% endif %}

    <div class="col-12 col-md-6">
      <label class="form-label">Name</label>
      <input class="form-control" name="name" value="{{ name }}" required {% if not _can_edit %}readonly{% endif %}>
    </div>

    <div class="col-12 col-md-6">
      <label class="form-label">Task Type</label>
      <input class="form-control" name="task_type" value="{{ task_type }}" required {% if not _can_edit %}readonly{% endif %}>
    </div>

    <div class="col-12 col-md-6">
      <label class="form-label">Due Date</label>
      <input class="form-control" type="datetime-local" name="due_date" value="{{ due_date }}" {% if not _can_edit %}readonly{% endif %}>
    </div>

    <div class="col-12">
      <label class="form-label">Description</label>
      <textarea class="form-control" name="description" rows="3" {% if not _can_edit %}readonly{% endif %}>{{ description }}</textarea>
    </div>

    <div class="col-12">
      <label class="form-label">URL</label>
      <input class="form-control" name="url" value="{{ url }}" {% if not _can_edit %}readonly{% endif %}>
    </div>

    <div class="col-12 col-md-4">
      <label class="form-label">Recurrence Type</label>
      <select class="form-select" name="recurrence_type" id="recurrence_type" {% if not _can_edit %}disabled{% endif %}>
        <option value="none" {% if recurrence_type == 'none' %}selected{% endif %}>None</option>
        <option value="post_completion" {% if recurrence_type == 'post_completion' %}selected{% endif %}>Post-completion</option>
        <option value="multi_slot_daily" {% if recurrence_type == 'multi_slot_daily' %}selected{% endif %}>Multi-slot daily</option>
        <option value="fixed_clock" {% if recurrence_type == 'fixed_clock' %}selected{% endif %}>Fixed clock</option>
      </select>
    </div>

    <div class="col-12 col-md-4" id="recurrence_interval_container">
      <label class="form-label">Recurrence Interval / Rule</label>
      <input class="form-control" name="recurrence_interval" value="{{ recurrence_interval }}" placeholder="e.g. 8h, Every Tuesday" {% if not _can_edit %}readonly{% endif %}>
      <div class="form-text">For fixed clock, you can use a duration or a calendar rule.</div>
    </div>

    <div class="col-12 col-md-4" id="recurrence_times_container">
      <label class="form-label">Recurrence Times</label>
      <input class="form-control" name="recurrence_times" value="{{ recurrence_times }}" placeholder="e.g. 08:00, 15:00" {% if not _can_edit %}readonly{% endif %}>
      <div class="form-text">Used for multi-slot daily.</div>
    </div>

    <div class="col-12">
      <label class="form-label">Tags (comma-separated)</label>
      <input class="form-control" name="tags" value="{{ tags }}" {% if not _can_edit %}readonly{% endif %}>
    </div>

    <div class="col-12 d-flex gap-2">
      {% if _can_edit %}
        <button class="btn btn-primary" type="submit">Save</button>
      {% endif %}
      <a class="btn btn-outline-secondary" href="{{ next_url }}">Back</a>
    </div>
  </div>
</form>

{% if mode == 'edit' and descendant_rows is defined %}
  <hr class="my-4">
  <h4>Subtasks</h4>

  {% if descendant_rows|length == 0 %}
    <div class="text-muted">No subtasks.</div>
  {% else %}
    <div class="list-group">
      {% for row in descendant_rows %}
        {% set st = row.task %}
        <div class="list-group-item">
          <div style="padding-left: {{ row.depth * 18 }}px;">
            <a href="/tasks/{{ st.id }}/edit?next={{ next_url|urlencode }}">{{ st.name }}</a>
            <span class="badge text-bg-light ms-2">{{ st.task_type }}</span>
            <span class="small text-muted ms-2">Due {{ st.due_date_utc|dt_local }}</span>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endif %}

{% endblock %}
